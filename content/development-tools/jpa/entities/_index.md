+++
title = "entities"
+++

# JPA Entities

JPA entities are Java objects that represent database data, where each JPA entity instance
represents a row in the table.

## Declaring Entities

```java
@Entity
@Table(name = "books")
public class Book {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private Long id;

  @Column(name = "title", length = 100, nullable = false, unique = false)
  private String title;
}
```

Entities can be declared using the `@Entity` annotation.
Each entity class is associated with a database table, and we can use the `@Table` annotation
to specify the details of the table.

JPA entities must have a no-argument constructor and a primary key.
Entity classes must not be final, since JPA implementations will try to subclass the entity class.

### Primary Key

#### Generated Keys

Primary keys are declared using the `@Id` annotation, and may be automatically generated by
the `@GeneratedValue` annotation.

The following are the strategies for `@GeneratedValue`.

- Auto
- Table
- Sequence
- Identity
- UUID

#### Natural Keys

`@NaturalID`

#### Composite Keys

`@EmbeddedId`

### Entity Fields

Column attributes can be explicitly declared using the `@Column` annotation.

The following are other specialized entity field annotations.

- `@Transient`
- `@Temporal`
- `@Enumerated`

## Entity Lifecycle

JPA maintains a persistence context, where the persistence context is a set of entity instances
that are connected with a persistent entity identity. The persistence context sits between
the application and database system providing conversion between entities and
persistent data. The persistence context of JPA is represented by the `EntityManager` class.

Entities in a persistence context can be either transient, managed, detached, or removed.

A newly created entity object is a transient object. It is just a simple Java object not
connected to any persisted entities.
Transient objects become managed by either calling the `persist` method

Managed objects are entity objects connected with the database. The persistence provider
will flush all changes to managed objects when the persistence context gets flushed.
Managed objects can be constructed using the `find` method.

A detached entity is an entity that is no longer attached to the persistence context.
Detached entities can become managed by calling the `merge` method. Detaching an entity
can be done using the `detach` method.

A removed entity is a deleted entity, but the delete call to the database will only occur
if the persistence context gets flushed.

```java
public class BookRepositoryImpl implements BookRepository {

  private final EntityManager em;

  public BookRepositoryImpl(EntityManager em) {
    this.em = em;
  }

  public void transientToManaged() {
    Book book = new Book("Title");
    em.persist(book);
  }

  public void dbToManaged() {
    Book book = em.find(Book.class, 1L);
  }

  public void detachedToManaged(Book book) {
    em.merge(book);
  }

  public void managedToDetached(Book book) {
    em.detach(book);
  }

  public void managedToRemoved(Book book) {
    em.remove(book);
  }
}
```

### Entity Lifecycle Events

JPA provides entity lifecycle events that methods can listen to. These events can be handled
either in a method within the entity or in an `EventListener` class. The event types are `persist`,
`remove`, `update`, and `load`, with each type providing events for pre-event and post-event.

```java
public class LifecycleEventListener {

  @PrePersist
  @PreUpdate
  @PreRemove
  private void beforeUpdate(Book book) {}

  @PostPersist
  @PostUpdate
  @PostRemove
  private void afterUpdate(Book book) {}
}

@Entity
@EntityListeners(LifecycleEventListener.class)
public class Book {

  @PostLoad
  public void afterLoad() {}
}
```
